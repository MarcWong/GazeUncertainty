"""
Example: Centroid position of gaze samples associated to fixation can deviate from the given fixation position (EyeLink fixation filter).
"""
import re
import numpy as np

# Source: G1/cy1.asc
lines = """SFIX L   21684601
21684601	  460.5	  291.3	 4441.0	  315.0	  685.9	 3649.0	.....
21684601	  435.8	  441.6	 4173.0	  321.0	  720.1	 3636.0	.....
21684602	  451.1	   95.8	 4658.0	  308.6	  674.7	 3611.0	.....
21684602	  470.6	  478.2	 4314.0	  315.2	  681.9	 3669.0	.....
21684603	  463.9	  456.7	 4210.0	  325.0	  714.3	 3637.0	.....
21684603	  456.4	  469.4	 4206.0	  310.9	  695.3	 3627.0	.....
21684604	  458.1	  464.8	 4189.0	  326.1	  708.1	 3637.0	.....
21684604	  461.8	  460.1	 4233.0	  331.3	  733.9	 3689.0	.....
21684605	  470.1	  465.2	 4182.0	  334.2	  742.6	 3632.0	.....
21684605	  445.1	  396.0	 4253.0	  322.0	  703.9	 3679.0	.....
21684606	  455.9	  455.5	 4226.0	  315.3	  688.4	 3644.0	.....
21684606	  456.7	  445.2	 4307.0	  316.0	  691.4	 3643.0	.....
21684607	  466.4	  438.7	 4282.0	  313.3	  716.0	 3644.0	.....
21684607	  454.0	  456.7	 4208.0	  332.1	  720.5	 3675.0	.....
21684608	  475.9	  110.6	 4694.0	  327.7	  688.7	 3656.0	.....
21684608	  453.8	  443.9	 4251.0	  300.2	  682.2	 3641.0	.....
21684609	  452.5	  424.7	 4256.0	  308.3	  699.1	 3672.0	.....
21684609	  455.9	  449.4	 4292.0	  309.3	  677.9	 3636.0	.....
21684610	  450.1	  444.9	 4192.0	  311.2	  720.8	 3601.0	.....
21684610	  471.0	  466.4	 4279.0	  324.6	  689.3	 3665.0	.....
MSG	21684611 _MousePosition_ 484 585
21684611	  461.3	  477.9	 4189.0	  314.9	  713.3	 3644.0	.....
21684611	  448.6	  285.8	 4531.0	  327.1	  703.8	 3665.0	.....
21684612	  449.9	  401.7	 4296.0	  328.5	  721.3	 3648.0	.....
21684612	  472.2	  468.9	 4244.0	  316.8	  696.6	 3630.0	.....
21684613	  456.3	  447.2	 4184.0	  326.7	  679.6	 3627.0	.....
21684613	  462.0	  443.2	 4237.0	  347.2	  745.4	 3693.0	.....
21684614	  474.7	  476.5	 4198.0	  308.9	  692.4	 3644.0	.....
21684614	  467.8	  468.6	 4215.0	  324.5	  701.2	 3614.0	.....
21684615	  477.9	  478.9	 4218.0	  315.7	  687.3	 3632.0	.....
21684615	  466.2	  397.3	 4255.0	  315.1	  728.3	 3654.0	.....
21684616	  472.4	  472.9	 4259.0	  329.4	  712.7	 3640.0	.....
21684616	  466.4	  450.4	 4209.0	  313.2	  686.8	 3615.0	.....
21684617	  455.3	  459.7	 4146.0	  321.3	  726.9	 3648.0	.....
21684617	  473.9	  461.6	 4228.0	  319.1	  715.1	 3643.0	.....
21684618	  482.9	  476.8	 4222.0	  324.5	  681.4	 3637.0	.....
21684618	  466.3	  432.1	 4241.0	  324.2	  714.0	 3682.0	.....
21684619	  448.8	  445.1	 4218.0	  335.5	  731.5	 3686.0	.....
21684619	  478.6	  452.6	 4279.0	  320.9	  689.2	 3620.0	.....
21684620	  468.5	  477.2	 4275.0	  319.0	  710.1	 3659.0	.....
21684620	  455.2	  434.8	 4177.0	  330.5	  703.3	 3645.0	.....
21684621	  463.7	  443.0	 4201.0	  311.2	  676.5	 3615.0	.....
21684621	  473.0	  408.9	 4292.0	  319.4	  690.0	 3636.0	.....
21684622	  469.8	  441.2	 4207.0	  334.4	  766.2	 3702.0	.....
21684622	  471.6	  459.2	 4259.0	  337.8	  705.2	 3662.0	.....
21684623	  486.9	  432.4	 4231.0	  324.4	  687.4	 3620.0	.....
21684623	  462.2	  451.9	 4212.0	  315.6	  669.3	 3636.0	.....
21684624	  460.3	  142.8	 4652.0	  339.9	  725.7	 3670.0	.....
21684624	  470.9	  456.9	 4217.0	  334.1	  703.6	 3624.0	.....
21684625	  480.6	  403.3	 4238.0	  340.8	  718.9	 3650.0	.....
21684625	  452.5	  440.0	 4227.0	  328.2	  728.0	 3651.0	.....
21684626	  464.1	  465.0	 4159.0	  346.2	  719.0	 3674.0	.....
21684626	  475.3	  226.7	 4525.0	  312.3	  699.9	 3670.0	.....
21684627	  459.9	  427.6	 4226.0	  345.1	  705.4	 3672.0	.....
21684627	  465.9	  461.1	 4208.0	  314.7	  692.6	 3617.0	.....
MSG	21684628 _MousePosition_ 481 585
21684628	  464.7	  451.3	 4246.0	  337.0	  714.7	 3658.0	.....
21684628	  476.1	  464.7	 4188.0	  328.4	  686.6	 3618.0	.....
21684629	  465.2	  425.5	 4230.0	  318.8	  714.9	 3660.0	.....
ESACC R  21684554	21684629	75	  412.4	  714.6	  329.9	  711.6	   1.40	    161
21684629	  462.9	  440.9	 4194.0	  337.0	  704.4	 3645.0	.....
SFIX R   21684630
21684630	  475.8	  480.3	 4179.0	  321.3	  686.0	 3612.0	.....
21684630	  476.5	  406.2	 4250.0	  319.5	  699.4	 3649.0	.....
21684631	  475.9	  486.3	 4224.0	  327.6	  711.8	 3659.0	.....
21684631	  453.2	  436.2	 4198.0	  319.7	  684.4	 3612.0	.....
21684632	  471.6	  121.4	 4612.0	  326.0	  701.3	 3665.0	.....
21684632	  490.4	  429.1	 4271.0	  332.1	  700.7	 3660.0	.....
21684633	  516.3	  159.3	 4604.0	  325.3	  714.1	 3650.0	.....
21684633	  471.8	  429.1	 4315.0	  334.9	  675.9	 3618.0	.....
21684634	  466.1	  430.6	 4249.0	  351.0	  689.9	 3642.0	.....
21684634	  484.7	  394.5	 4384.0	  341.3	  726.4	 3669.0	.....
21684635	  469.0	  467.0	 4178.0	  336.7	  721.9	 3630.0	.....
21684635	  472.2	  411.1	 4265.0	  335.4	  721.8	 3645.0	.....
21684636	  471.4	  443.9	 4246.0	  323.3	  669.0	 3610.0	.....
21684636	  467.7	  465.5	 4192.0	  325.7	  698.3	 3630.0	.....
21684637	  477.7	  445.8	 4216.0	  322.1	  680.8	 3617.0	.....
21684637	  487.9	  452.4	 4211.0	  335.1	  727.0	 3674.0	.....
21684638	  492.8	  299.4	 4375.0	  337.2	  693.9	 3643.0	.....
21684638	  470.5	  455.6	 4161.0	  331.1	  704.6	 3620.0	.....
21684639	  473.4	  404.3	 4243.0	  336.7	  688.3	 3607.0	.....
21684639	  464.6	  419.0	 4232.0	  331.7	  698.1	 3640.0	.....
21684640	  384.7	  122.6	 4516.0	  339.2	  714.2	 3640.0	.....
21684640	  462.3	  436.7	 4225.0	  343.2	  717.0	 3654.0	.....
21684641	  467.6	  414.5	 4235.0	  349.6	  704.8	 3659.0	.....
21684641	  462.3	  441.1	 4271.0	  318.7	  695.2	 3638.0	.....
21684642	  478.8	  458.5	 4192.0	  330.8	  720.0	 3647.0	.....
21684642	  485.1	  405.2	 4264.0	  328.4	  684.9	 3631.0	.....
21684643	  465.4	  436.8	 4209.0	  324.4	  718.1	 3653.0	.....
21684643	  489.4	  487.3	 4184.0	  336.2	  722.4	 3618.0	.....
21684644	  466.1	  458.8	 4164.0	  318.8	  688.2	 3610.0	.....
21684644	  478.7	  467.3	 4214.0	  314.3	  700.4	 3624.0	.....
MSG	21684645 _MousePosition_ 475 586
21684645	  481.7	  427.6	 4281.0	  349.9	  704.4	 3688.0	.....
21684645	  372.2	   75.1	 4532.0	  359.7	  750.6	 3674.0	.....
21684646	  468.7	  460.6	 4190.0	  338.9	  691.0	 3615.0	.....
21684646	  472.5	  429.9	 4234.0	  332.3	  721.7	 3643.0	.....
21684647	  478.8	  449.7	 4210.0	  329.0	  700.0	 3645.0	.....
21684647	  476.8	  453.8	 4251.0	  324.3	  686.2	 3618.0	.....
21684648	  492.5	   84.1	 4675.0	  330.9	  702.5	 3630.0	.....
21684648	  475.4	  458.0	 4122.0	  336.6	  679.8	 3606.0	.....
21684649	  363.5	   78.0	 4617.0	  337.5	  732.4	 3704.0	.....
21684649	  478.4	  459.6	 4225.0	  339.9	  724.2	 3646.0	.....
21684650	  486.7	  470.5	 4203.0	  335.7	  703.3	 3607.0	.....
EFIX L   21684601	21684650	49	  468.6	  446.3	   4232"""


lines = lines.split('\n')

# EFIX L event
efix_L = lines[-1].split()

# This is the true fixation position (left eye)
fx, fy = float(efix_L[5]), float(efix_L[6])

# Extract lines between SFIX L and EFIX L events
between_lines = lines[1:-2]

# Filter out other events such as blinks, saccades
between_lines = filter(lambda l: re.match(r'\d+\s*((-)?\d*\.\d*\s*){6}', l), between_lines)

# Extract columns
between_lines = list(map(lambda l: l.split(), between_lines))

# Extract gaze left position
gaze_left_pos = list(map(lambda l: (float(l[1]), float(l[2])), between_lines))
gaze_left_pos = np.array(gaze_left_pos)

# Calculate mean of gaze samples associated to fixation
avg = gaze_left_pos.mean(axis=0)

# Output: Fixation X,Y: 468.60, 446.30
print(f'Fixation X,Y: {fx:.2f}, {fy:.2f}')

# Output: Mean Gaze X,Y: 465.58, 408.66
print(f'Mean Gaze X,Y: {avg[0]:.2f}, {avg[1]:.2f}')
